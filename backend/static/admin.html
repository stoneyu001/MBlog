<!DOCTYPE html>
<html>

<head>
    <title>åšå®¢ç®¡ç†ç³»ç»Ÿ</title>
    <meta charset="UTF-8">
    <style>
        body {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        h1 {
            color: #333;
        }

        .container {
            display: flex;
        }

        .left-panel {
            flex: 1;
            padding-right: 20px;
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            flex: 2;
        }

        .file-list-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #eee;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        textarea {
            width: 100%;
            height: 500px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid #ddd;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            background: #45a049;
        }

        button.grafana-btn {
            background: #2196F3;
        }

        button.grafana-btn:hover {
            background: #0b7dda;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        li:hover {
            background: #f5f5f5;
        }

        .file-list-title {
            margin-bottom: 10px;
            font-weight: bold;
        }

        .actions {
            margin-top: 10px;
        }

        .top-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
    </style>
</head>

<body>
    <h1>åšå®¢ç®¡ç†ç³»ç»Ÿ</h1>

    <div class="top-actions">
        <button class="grafana-btn" onclick="window.open('http://localhost:3001/d/mblog-analytics', '_blank')">
            ğŸ“Š æŸ¥çœ‹æ•°æ®åˆ†æ (Grafana)
        </button>
    </div>

    <div class="container">
        <div class="left-panel">
            <div class="file-list-title">æ–‡ç« åˆ—è¡¨</div>
            <div class="file-list-container">
                <ul id="fileList"></ul>
            </div>
            <div class="actions">
                <button id="newFile">æ–°å»ºæ–‡ç« </button>
                <button id="buildSite">é‡æ–°ç”Ÿæˆç«™ç‚¹</button>
            </div>
        </div>

        <div class="right-panel">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <select id="directory" style="padding: 8px; border: 1px solid #ddd;">
                    <option value="tech">æŠ€æœ¯æ ˆå¿—</option>
                    <option value="life">ç”Ÿæ´»æ‹¾æ’·</option>
                </select>
                <input type="text" id="filename" placeholder="æ–‡ä»¶å (ä¾‹å¦‚: my-post.md)" style="flex: 1;" />
            </div>
            <textarea id="editor" placeholder="åœ¨è¿™é‡Œè¾“å…¥ Markdown å†…å®¹..."></textarea>
            <div class="actions">
                <button id="saveFile">ä¿å­˜æ–‡ä»¶</button>
                <button id="deleteFile">åˆ é™¤æ–‡ä»¶</button>
            </div>
        </div>
    </div>

    <script>
        // è·å–æ–‡ä»¶åˆ—è¡¨
        function loadFileList() {
            fetch('/api/files')
                .then(res => res.json())
                .then(files => {
                    const fileList = document.getElementById('fileList');
                    fileList.innerHTML = '';

                    files.forEach(file => {
                        const li = document.createElement('li');
                        li.textContent = file;
                        li.onclick = () => loadFile(file);
                        fileList.appendChild(li);
                    });
                })
                .catch(err => console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', err));
        }

        // åŠ è½½æ–‡ä»¶å†…å®¹
        function loadFile(filename) {
            const relativeFilename = filename.replace('/app/frontend/docs/', '');

            if (relativeFilename.startsWith('tech/')) {
                document.getElementById('directory').value = 'tech';
            } else if (relativeFilename.startsWith('life/')) {
                document.getElementById('directory').value = 'life';
            }

            fetch(`/api/files/${relativeFilename}`)
                .then(res => res.text())
                .then(content => {
                    const displayFilename = relativeFilename.replace(/^(tech|life)\//, '');
                    document.getElementById('filename').value = displayFilename;
                    document.getElementById('editor').value = content;
                })
                .catch(err => console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', err));
        }

        // ä¿å­˜æ–‡ä»¶
        document.getElementById('saveFile').addEventListener('click', () => {
            let filename = document.getElementById('filename').value;
            const content = document.getElementById('editor').value;
            const directory = document.getElementById('directory').value;

            if (!filename) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å');
                return;
            }

            if (!filename.startsWith('tech/') && !filename.startsWith('life/')) {
                filename = `${directory}/${filename}`;
            }

            fetch('/api/files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename, content })
            })
                .then(res => {
                    if (res.ok) {
                        alert('æ–‡ä»¶ä¿å­˜æˆåŠŸ');
                        loadFileList();
                    } else {
                        alert('ä¿å­˜å¤±è´¥');
                    }
                })
                .catch(err => console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', err));
        });

        // åˆ é™¤æ–‡ä»¶
        document.getElementById('deleteFile').addEventListener('click', () => {
            const filename = document.getElementById('filename').value;

            if (!filename) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶');
                return;
            }

            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ ${filename} å—ï¼Ÿ`)) {
                return;
            }

            const relativePath = filename.replace('/app/frontend/docs/', '');

            fetch(`/api/files/${relativePath}`, {
                method: 'DELETE'
            })
                .then(res => {
                    if (res.ok) {
                        alert('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
                        document.getElementById('filename').value = '';
                        document.getElementById('editor').value = '';
                        loadFileList();
                    } else {
                        alert('åˆ é™¤å¤±è´¥');
                    }
                })
                .catch(err => console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', err));
        });

        // æ–°å»ºæ–‡ä»¶
        document.getElementById('newFile').addEventListener('click', () => {
            document.getElementById('filename').value = '';
            document.getElementById('editor').value = '';
        });

        // æ„å»ºç«™ç‚¹
        document.getElementById('buildSite').addEventListener('click', () => {
            fetch('/api/build', { method: 'POST' })
                .then(res => {
                    if (res.ok) {
                        alert('ç«™ç‚¹æ„å»ºæˆåŠŸ');
                    } else {
                        alert('ç«™ç‚¹æ„å»ºå¤±è´¥');
                    }
                })
                .catch(err => console.error('æ„å»ºç«™ç‚¹å¤±è´¥:', err));
        });

        // åˆå§‹åŠ è½½
        loadFileList();
    </script>
</body>

</html>