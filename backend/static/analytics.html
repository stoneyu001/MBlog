<!DOCTYPE html>
<html>
<head>
    <title>博客数据分析</title>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        body { max-width: 1200px; margin: 20px auto; padding: 20px; font-family: 'Microsoft YaHei', sans-serif; }
        h1, h2 { color: #333; }
        .chart-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .chart { width: 48%; height: 350px; background: #fff; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px; }
        .full-width { width: 100%; }
        .dashboard-section { margin-bottom: 40px; }
        .metrics-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .metric-card { flex: 1; padding: 20px; background: #f9f9f9; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .metric-value { font-size: 24px; font-weight: bold; margin: 10px 0; color: #4CAF50; }
        .date-filter { margin-bottom: 20px; }
        .date-filter select { padding: 8px 12px; border-radius: 4px; border: 1px solid #ddd; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .loading-content { text-align: center; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4CAF50; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <h1>博客数据分析</h1>

    <div class="date-filter">
        <label for="time-range">时间范围：</label>
        <select id="time-range" onchange="refreshData()">
            <option value="7">最近7天</option>
            <option value="30" selected>最近30天</option>
            <option value="90">最近90天</option>
            <option value="all">全部时间</option>
        </select>
    </div>

    <div class="dashboard-section">
        <h2>核心指标</h2>
        <div class="metrics-row">
            <div class="metric-card">
                <div>总访问量</div>
                <div class="metric-value" id="total-visits">-</div>
            </div>
            <div class="metric-card">
                <div>独立访客数</div>
                <div class="metric-value" id="unique-visitors">-</div>
            </div>
            <div class="metric-card">
                <div>平均停留时间</div>
                <div class="metric-value" id="avg-duration">-</div>
            </div>
            <div class="metric-card">
                <div>跳出率</div>
                <div class="metric-value" id="bounce-rate">-</div>
            </div>
        </div>
    </div>

    <div class="dashboard-section">
        <h2>访问趋势</h2>
        <div class="chart-container">
            <div id="visits-trend" class="chart full-width"></div>
        </div>
    </div>

    <div class="dashboard-section">
        <h2>页面分析</h2>
        <div class="chart-container">
            <div id="top-pages" class="chart"></div>
            <div id="visit-duration" class="chart"></div>
        </div>
    </div>

    <div class="dashboard-section">
        <h2>用户行为</h2>
        <div class="chart-container">
            <div id="event-types" class="chart"></div>
            <div id="user-paths" class="chart"></div>
        </div>
    </div>

    <div class="dashboard-section">
        <h2>设备与平台</h2>
        <div class="chart-container">
            <div id="platforms" class="chart"></div>
            <div id="browsers" class="chart"></div>
        </div>
    </div>

    <div id="loading" class="loading" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>加载中...</div>
        </div>
    </div>

    <script>
        // 图表实例对象
        let charts = {};
        let chartsInitialized = false;

        // 初始化所有图表
        function initCharts() {
            if (chartsInitialized) {
                return;
            }

            const chartIds = [
                'visits-trend', 'top-pages', 'visit-duration',
                'event-types', 'user-paths', 'platforms', 'browsers'
            ];

            chartIds.forEach(id => {
                const dom = document.getElementById(id);
                if (dom && !charts[id]) {
                    charts[id] = echarts.init(dom, null, {
                        renderer: 'canvas',
                        useDirtyRect: true,
                        pointerOptions: {
                            passive: true
                        }
                    });
                }
            });

            chartsInitialized = true;
        }

        // 刷新所有数据
        async function refreshData() {
            showLoading();
            const timeRange = document.getElementById('time-range').value;
            
            try {
                // 获取统计数据
                const response = await fetch(`/api/tracking/analytics?days=${timeRange}`);
                const data = await response.json();
                
                // 更新核心指标
                updateMetrics(data.metrics);
                
                // 更新各个图表
                updateVisitsTrend(data.visitsTrend);
                updateTopPages(data.topPages);
                updateVisitDuration(data.visitDuration);
                updateEventTypes(data.eventTypes);
                updateUserPaths(data.userPaths);
                updatePlatforms(data.platforms);
                updateBrowsers(data.browsers);
            } catch (error) {
                console.error('获取数据失败:', error);
                alert('获取数据失败，请稍后重试');
            } finally {
                hideLoading();
            }
        }

        // 更新核心指标
        function updateMetrics(metrics) {
            document.getElementById('total-visits').textContent = metrics.totalVisits.toLocaleString();
            document.getElementById('unique-visitors').textContent = metrics.uniqueVisitors.toLocaleString();
            document.getElementById('avg-duration').textContent = formatDuration(metrics.avgDuration);
            document.getElementById('bounce-rate').textContent = metrics.bounceRate.toFixed(1) + '%';
        }

        // 更新访问趋势图表
        function updateVisitsTrend(data) {
            const option = {
                title: { text: '访问趋势' },
                tooltip: { trigger: 'axis' },
                legend: { data: ['访问量', '独立访客'] },
                xAxis: { type: 'category', data: data.dates },
                yAxis: { type: 'value' },
                series: [
                    { name: '访问量', type: 'line', data: data.visits },
                    { name: '独立访客', type: 'line', data: data.visitors }
                ]
            };
            charts['visits-trend'].setOption(option);
        }

        // 更新热门页面图表
        function updateTopPages(data) {
            const option = {
                title: { text: '热门页面 (Top 5)' },
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const param = params[0];
                        // 在tooltip中显示完整的页面名称
                        return `${data.pages[param.dataIndex]}<br/>访问量: ${param.value}`;
                    },
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                grid: {
                    left: '3%',     // 减小左边距
                    right: '5%',    // 减小右边距
                    bottom: '3%',   // 减小底部边距
                    top: '15%',     // 减小顶部边距
                    containLabel: true  // 确保标签在图表区域内
                },
                xAxis: { type: 'value' },
                yAxis: {
                    type: 'category',
                    data: data.pages,
                    axisLabel: {
                        formatter: function(value) {
                            // 计算字符长度（中文算2个字符，英文算1个字符）
                            let len = 0;
                            let displayLen = 0;
                            for(let i = 0; i < value.length; i++) {
                                if(value.charCodeAt(i) > 127) {
                                    len += 2;
                                } else {
                                    len += 1;
                                }
                                if(len <= 8) { // 允许4个中文字符（8个字符长度）
                                    displayLen = i + 1;
                                }
                            }
                            if(displayLen < value.length) {
                                return value.substring(0, displayLen) + '...';
                            }
                            return value;
                        },
                        show: true,
                        interval: 0
                    }
                },
                series: [{
                    name: '访问量',
                    type: 'bar',
                    data: data.visits,
                    label: {
                        show: true,
                        position: 'right',
                        formatter: '{c}'
                    }
                }]
            };
            charts['top-pages'].setOption(option);

            // 添加鼠标悬停事件，显示完整文本
            charts['top-pages'].getZr().on('mousemove', function(params) {
                const pointInPixel = [params.offsetX, params.offsetY];
                const pointInGrid = charts['top-pages'].convertFromPixel({seriesIndex: 0}, pointInPixel);
                if (pointInGrid) {
                    const dataIndex = Math.floor(pointInGrid[1]);
                    if (dataIndex >= 0 && dataIndex < data.pages.length) {
                        charts['top-pages'].setTooltip({
                            formatter: data.pages[dataIndex]
                        });
                    }
                }
            });
        }

        // 更新访问时长分布图表
        function updateVisitDuration(data) {
            const option = {
                title: { text: '访问时长分布' },
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: '50%',
                    data: data
                }]
            };
            charts['visit-duration'].setOption(option);
        }

        // 更新事件类型分布图表
        function updateEventTypes(data) {
            const option = {
                title: { text: '事件类型分布' },
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: '50%',
                    data: data
                }]
            };
            charts['event-types'].setOption(option);
        }

        // 更新用户路径图表
        function updateUserPaths(data) {
            if (!data || !data.nodes || !data.links || data.nodes.length === 0) {
                console.warn('用户路径数据为空或无效，跳过图表更新', data);
                return;
            }

            // 确保节点名称唯一
            const uniqueNodes = {};
            const processedNodes = [];
            data.nodes.forEach((node, index) => {
                if (!uniqueNodes[node.name]) {
                    uniqueNodes[node.name] = true;
                    processedNodes.push({
                        ...node,
                        id: `node_${index}`
                    });
                }
            });

            const option = {
                title: { text: '用户路径分析' },
                tooltip: { 
                    trigger: 'item',
                    formatter: '{b}: {c}'
                },
                series: [{
                    type: 'sankey',
                    layout: 'none',
                    emphasis: {
                        focus: 'adjacency'
                    },
                    data: processedNodes,
                    links: data.links,
                    lineStyle: {
                        color: 'source',
                        curveness: 0.5
                    }
                }]
            };

            const chart = charts['user-paths'];
            if (chart) {
                try {
                    chart.setOption(option, true);
                } catch (error) {
                    console.error('设置用户路径图表选项时出错:', error);
                }
            }
        }

        // 更新平台分布图表
        function updatePlatforms(data) {
            const option = {
                title: { text: '平台分布' },
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: '50%',
                    data: data
                }]
            };
            charts['platforms'].setOption(option);
        }

        // 更新浏览器分布图表
        function updateBrowsers(data) {
            const option = {
                title: { text: '浏览器分布' },
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: '50%',
                    data: data
                }]
            };
            charts['browsers'].setOption(option);
        }

        // 格式化时长
        function formatDuration(seconds) {
            if (seconds < 60) {
                return seconds.toFixed(1) + '秒';
            }
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = (seconds % 60).toFixed(1);
            return minutes + '分' + remainingSeconds + '秒';
        }

        // 显示加载状态
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // 确保 DOM 完全加载后再初始化图表
        function ensureChartsInitialized() {
            if (document.readyState === 'complete') {
                initCharts();
                refreshData();
            } else {
                window.addEventListener('load', () => {
                    initCharts();
                    refreshData();
                });
            }
        }

        // 窗口大小改变时重绘图表
        window.addEventListener('resize', () => {
            if (chartsInitialized) {
                Object.values(charts).forEach(chart => {
                    if (chart && chart.resize) {
                        try {
                            chart.resize();
                        } catch (error) {
                            console.error('重绘图表时出错:', error);
                        }
                    }
                });
            }
        });

        // 初始化
        ensureChartsInitialized();
    </script>
</body>
</html> 